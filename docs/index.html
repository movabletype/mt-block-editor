<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title></title>
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style type="text/css">
      body > div {
        margin: 10px 200px;
      }
      @media (max-width: 991.5px) {
        body > div {
          margin: 0;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="./mt-rich-text-editor/style.css"
    />
    <script
      src="./mt-rich-text-editor/mt-rich-text-editor.js"
      type="module"
      referrerpolicy="origin"
    ></script>
  </head>
  <body>
    <div>
      <form style="margin-top: 80px;">
        <textarea id="body"></textarea>
        <input type="submit" id="submit" />
        <input type="reset" id="reset" />
        <input type="submit" id="unload" value="Unload" />
        <input type="submit" id="toggle-mode" value="Toggle mode" />
      </form>
    </div>
    <script type="module">
      const applyOpts = {
        mode: sessionStorage.getItem("MTBlockEditorMode") || "composition",
        id: "body",
        stylesheets: [
          (() => {
            const a = document.createElement("a");
            a.href = "./editor-content.css";
            return a.href;
          })(),
        ],
        i18n: {
          lng: "ja",
          debug: true,
          //backend: {
          //  loadPath: `https://example.com/mt-block-editor/locales/{{lng}}/{{ns}}.json`,
          //  crossDomain: true,
          //},
        },
        shortcutBlockTypes: ["core-text", "core-image", "core-file"],
        panelBlockTypes: [
          "core-text",
          "core-image",
          "core-file",
          "core-horizontalrule",
          "core-html",
          "core-table",
          "core-columns",
          "custom-oembed",
          "custom-excel",
          "custom-text",
        ],
      };

      window.document.getElementById("body").value =
        window.sessionStorage.getItem("MTBlockEditorBody") || "";

      const ts = new Date().getTime();
      const loader = [
        "./dist/mt-block-editor.js",
        "./register-block.js",
        // "./dist/mt-block-editor-block-form-element.js",
        // "./blocks-officer.html",
      ].reduce(
        (chain, m) =>
          chain.then(() => {
            if (m.match(/\.html/)) {
              return fetch(m)
                .then((res) => res.text())
                .then((html) => {
                  const t = document.createElement("template");
                  t.innerHTML = html;
                  document.body.appendChild(t.content);
                });
            } else {
              return import(`${m}?ts=${ts}`);
            }
          }),
        Promise.resolve()
      );

      if (/^localhost(?::|$)/.test(location.host)) {
        // Probably in the development environment.
      } else {
        ["./dist/mt-block-editor.css"].forEach((url) => {
          const link = window.document.createElement("link");
          link.rel = "stylesheet";
          link.href = `${url}?ts=${ts}`;
          window.document.querySelector("head").appendChild(link);
        });
      }

      loader
        .then(async () => {
          const blocksElm = document.querySelector(
            `[data-block-types][data-blocks]`
          );
          const blockTypes = blocksElm && blocksElm.dataset.blockTypes;
          const blocks = blocksElm && blocksElm.dataset.blocks;
          if (!(blocks && blockTypes)) {
            return;
          }
          const { registerBoilerplateBlocks } = await import(
            `./dist/register-boilerplate-blocks.js?ts=${ts}`
          );

          registerBoilerplateBlocks(
            window.MTBlockEditor,
            JSON.parse(blockTypes),
            JSON.parse(blocks)
          );
          Reflect.deleteProperty(applyOpts, "panelBlockTypes");
        })
        .then(() => {
          return window;
        })
        .then(({ MTBlockEditor, sessionStorage, document }) => {
          MTBlockEditor.apply(applyOpts).then((ed) => {
            ed.on("initializeBlocks", ({ blocks }) => {
              console.log(blocks);
            });
            ed.on("buildTinyMCESettings", ({ block, settings }) => {
              console.log(block.constructor.typeId);
              settings.extended_valid_elements = [
                // we embed 'a[onclick]' by inserting image with popup
                `a[id|class|style|title|accesskey|tabindex|lang|dir|draggable|dropzone|contextmenu|hidden|onclick|href|target|name]`,
                // allow SPAN element without attributes
                `span[id|class|style|title|accesskey|tabindex|lang|dir|draggable|dropzone|contextmenu|hidden|onclick]`,
                // allow SCRIPT element
                "script[id|name|type|src]",
              ].join(",");
              settings.valid_children = "+a[div]";
            });
          });

          document
            .getElementById("submit")
            .form.addEventListener("submit", function (ev) {
              ev.preventDefault();
              MTBlockEditor.serialize().then(function () {
                console.log("serialized");
                sessionStorage.setItem(
                  "MTBlockEditorBody",
                  document.querySelector("#body").value
                );
              });
            });

          document
            .getElementById("reset")
            .addEventListener("click", function (ev) {
              ev.preventDefault();
              sessionStorage.setItem("MTBlockEditorBody", "");
              location.reload();
            });

          document
            .getElementById("unload")
            .addEventListener("click", function (ev) {
              ev.preventDefault();
              MTBlockEditor.unload({ id: "body" });
            });

          document
            .getElementById("toggle-mode")
            .addEventListener("click", function (ev) {
              ev.preventDefault();

              const cur =
                sessionStorage.getItem("MTBlockEditorMode") || "composition";
              const next = cur === "composition" ? "setup" : "composition";
              sessionStorage.setItem("MTBlockEditorMode", next);
              location.reload();
            });
        });
    </script>
  </body>
</html>
